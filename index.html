<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Where's Matt - AT Thru-Hike Tracker</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="timeline">
      <h2>Timeline</h2>
      <div id="timeline-entries">Loading...</div>
    </div>
    <div id="map"></div>
    <div id="stats">
      <h1>Where's Matt</h1>
      <div id="miles">Loading...</div>
      <div id="last-update"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Initialize map centered on the Appalachian Trail
      const map = L.map("map").setView([37.5, -79], 6);

      // Add OpenStreetMap tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Custom marker icons
      const greenIcon = L.divIcon({
        className: "marker-icon marker-completed",
        iconSize: [12, 12],
      });

      const currentIcon = L.divIcon({
        className: "marker-icon marker-current",
        iconSize: [16, 16],
      });

      // Load trail data
      fetch("trail.json")
        .then((response) => response.json())
        .then((trailData) => {
          L.geoJSON(trailData, {
            style: {
              color: "#8B4513",
              weight: 3,
              opacity: 0.7,
            },
          }).addTo(map);
        })
        .catch((err) => console.log("Trail data not loaded:", err));

      // Load progress data
      fetch("progress.json")
        .then((response) => response.json())
        .then((entries) => {
          if (entries.length === 0) {
            document.getElementById("miles").textContent = "No entries yet";
            document.getElementById("timeline-entries").textContent = "No entries yet.";
            return;
          }

          const markers = [];

          // Add markers for each entry
          entries.forEach((entry, index) => {
            const isLatest = index === entries.length - 1;
            const icon = isLatest ? currentIcon : greenIcon;

            const marker = L.marker([entry.lat, entry.lng], { icon }).addTo(map)
              .bindPopup(`
                            <strong>${entry.date}${entry.time ? " " + entry.time : ""}</strong><br>
                            Mile ${entry.mile}<br>
                            ${entry.notes}
                        `, { maxHeight: 200 });

            markers.push(marker);

            if (isLatest) {
              marker.openPopup();
            }
          });

          // Draw line connecting progress points
          if (entries.length > 1) {
            const progressLine = entries.map((e) => [e.lat, e.lng]);
            L.polyline(progressLine, {
              color: "#228B22",
              weight: 4,
              opacity: 0.8,
            }).addTo(map);
          }

          // Update stats
          const latest = entries[entries.length - 1];
          document.getElementById("miles").textContent =
            `Mile ${latest.mile} of 2,190`;
          document.getElementById("last-update").textContent =
            `Last update: ${latest.date}`;

          // Build timeline (newest first)
          const timelineEl = document.getElementById("timeline-entries");
          timelineEl.innerHTML = "";
          for (let i = entries.length - 1; i >= 0; i--) {
            const entry = entries[i];
            const isLatest = i === entries.length - 1;

            const card = document.createElement("div");
            card.className = "timeline-card" + (isLatest ? " timeline-card-current" : "");

            const header = document.createElement("div");
            header.className = "timeline-card-header";
            header.textContent = entry.date + (entry.time ? " " + entry.time : "");

            const mile = document.createElement("div");
            mile.className = "timeline-card-mile";
            mile.textContent = "Mile " + entry.mile;

            const notes = document.createElement("div");
            notes.className = "timeline-card-notes";
            notes.textContent = entry.notes;

            card.appendChild(header);
            card.appendChild(mile);
            card.appendChild(notes);

            const idx = i;
            card.addEventListener("click", () => {
              map.setView([entries[idx].lat, entries[idx].lng], 13);
              markers[idx].openPopup();
            });

            timelineEl.appendChild(card);
          }

          // Center map on latest position
          map.setView([latest.lat, latest.lng], 10);
        })
        .catch((err) => {
          console.error("Error loading progress:", err);
          document.getElementById("miles").textContent = "Error loading data";
        });
    </script>
  </body>
</html>
